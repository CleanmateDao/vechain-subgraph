# User State Entity - merges all user-related events
type User @entity(immutable: false) {
  id: Bytes! # user address
  metadata: String
  email: String # email address (immutable, set once during registration)
  emailVerified: Boolean!
  referralCode: String
  referrer: Bytes # address of referrer
  referralCount: BigInt! # number of users referred by this user
  registeredAt: BigInt!
  emailVerifiedAt: BigInt
  lastProfileUpdateAt: BigInt
  # NativePassport reference
  passport: NativePassport
  # Team membership info (for when user is a team member) - query by member address
  teamMemberships: [TeamMembership!]! @derivedFrom(field: "memberUser")
  # Rewards tracking (matches contract Reward struct)
  bonus: BigInt! # Bonus rewards received
  referral: BigInt! # Referral rewards received
  others: BigInt! # Other types of rewards received
  received: BigInt! # Total rewards received
}

# Team Membership - tracks team member relationships
type TeamMembership @entity(immutable: false) {
  id: ID! # organizer address + member address
  organizer: Bytes! # address
  member: Bytes! # address
  memberUser: User! # reference to User entity
  canEditImpacts: Boolean!
  canManageParticipants: Boolean!
  canSubmitProof: Boolean!
  addedAt: BigInt!
  lastUpdatedAt: BigInt!
  deleted: Boolean! # marks if the membership has been removed
  deletedAt: BigInt # timestamp when the membership was removed
}

# Impact State Entity - merges all impact-related events
type Impact @entity(immutable: false) {
  id: String! # impact ID (uint256 as string)
  organizer: Bytes! # address
  metadata: String!
  category: String
  date: BigInt! # uint256
  startTime: BigInt
  endTime: BigInt
  maxParticipants: BigInt
  status: Int! # uint8
  published: Boolean!
  publishedAt: BigInt
  unpublishedAt: BigInt
  createdAt: BigInt!
  updatedAt: BigInt
  isPrivate: Boolean! # whether the impact is private (no schedule needed, no public view)
  # Participants
  participants: [ImpactParticipant!]! @derivedFrom(field: "impact")
  # Proof of work
  proofOfWorkSubmitted: Boolean!
  proofOfWork: ProofOfWork @derivedFrom(field: "impact")
  proofOfWorkSubmittedAt: BigInt
  # Updates
  updates: [ImpactUpdate!]! @derivedFrom(field: "impact")
  updatesCount: BigInt
  # Location
  location: String # address
  city: String
  country: String
  latitude: BigDecimal
  longitude: BigDecimal
  # Rewards
  rewardAmount: BigInt
  rewardsDistributed: Boolean!
  rewardsTotalAmount: BigInt
  rewardsParticipantCount: BigInt
  rewardsDistributedAt: BigInt
}

# Proof of Work - stores Proof of Work Medias URLs with MIME types
type ProofOfWork @entity(immutable: true) {
  id: ID! # impact ID + submission timestamp + media index
  impact: Impact!
  # Media/Proof
  ipfsHashes: [String!]!
  mimetypes: [String!]!
  submittedAt: BigInt!
}

# Impact Update - tracks updates/announcements for impact events
type ImpactUpdate @entity(immutable: true) {
  id: ID! # transaction hash + log index
  impact: Impact!
  organizer: Bytes! # address of organizer/editor who added the update
  metadata: String! # update content/metadata
  addedAt: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# Impact Participant - tracks participant state per impact
type ImpactParticipant @entity(immutable: false) {
  id: ID! # impact ID + participant address
  impact: Impact!
  participant: Bytes! # address
  user: User! # reference to User entity
  appliedAt: BigInt!
  status: String! # "applied", "accepted", "rejected"
  acceptedAt: BigInt
  rejectedAt: BigInt
  # Reward earned for this impact
  rewardEarned: BigInt!
  rewardEarnedAt: BigInt
}

# Transaction Entity - tracks all reward transactions (CLAIM, RECEIVE)
type Transaction @entity(immutable: true) {
  id: ID! # transaction hash + log index (unique per event)
  user: Bytes! # address
  impactId: BigInt # impact ID (uint256, null for non-impact rewards)
  streakSubmissionId: BigInt # streak submission id (0 for non-streak rewards)
  amount: BigInt! # uint256
  transactionType: String! # "CLAIM" or "RECEIVE"
  rewardType: Int # rewardType from event (0=REFERRAL, 1=BONUS, 2=IMPACT, 3=STREAK, 4=OTHERS) (null for CLAIM transactions)
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# Notifications Schema
type Notification @entity(immutable: true) {
  id: ID!
  user: Bytes! # address
  type: String! # notification type (e.g., "impact_created", "participant_accepted", "reward_earned")
  title: String!
  message: String!
  relatedEntity: String # ID of related entity (impact ID as string, user address, etc.)
  relatedEntityType: String # type of related entity
  createdAt: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# Address Updated - tracks address updates in AddressesProvider
type AddressUpdated @entity(immutable: true) {
  id: ID!
  key: String!
  oldAddress: Bytes!
  newAddress: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# AppId Updated - tracks app ID updates in RewardsManager
type AppIdUpdated @entity(immutable: true) {
  id: ID!
  oldAppId: Bytes!
  newAppId: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# Rewards Pool Updated - tracks rewards pool address updates in RewardsManager
type RewardsPoolUpdated @entity(immutable: true) {
  id: ID!
  oldPool: Bytes!
  newPool: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# Streak Submission Entity - tracks sustainable action submissions
type StreakSubmission @entity(immutable: false) {
  id: ID! # submissionId
  user: Bytes! # address
  submissionId: BigInt!
  metadata: String!
  status: Int! # 0=PENDING, 1=APPROVED, 2=REJECTED, 3=REWARDED
  submittedAt: BigInt!
  reviewedAt: BigInt
  amount: BigInt # amount approved (null if not approved)
  rewardAmount: BigInt # amount approved (alias of amount; preferred field name)
  rejectionReason: String # reason for rejection (null if not rejected)
  # Media/Proof
  ipfsHashes: [String!]!
  mimetypes: [String!]!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# User Streak Stats - tracks user's streak-related statistics
type UserStreakStats @entity(immutable: false) {
  id: Bytes! # user address
  user: Bytes! # address
  totalSubmissions: BigInt!
  approvedSubmissions: BigInt!
  rejectedSubmissions: BigInt!
  pendingSubmissions: BigInt!
  totalAmount: BigInt! # total amount from approved submissions
  lastSubmissionAt: BigInt
}

# NativePassport Entity - tracks KYC verification status from NativePassport contract
type NativePassport @entity(immutable: false) {
  id: Bytes! # user address
  user: Bytes! # address
  status: Int! # KYCStatus enum: 0=NOT_STARTED, 1=PENDING, 2=VERIFIED, 3=REJECTED
  reason: String # reason for status (empty string if VERIFIED, error message otherwise)
  documentType: Int # DocumentType enum: 0=None, 1=NationalID, 2=DriversLicense, 3=Passport, 4=VotersCard, 5=Other
  updatedAt: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}
